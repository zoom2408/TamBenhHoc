<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Tương Tác – Phổ Lưỡng Cực</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100">

  <!-- Main container for the quiz app -->
  <div id="app"></div>

  <script>
    // ========================================================================
    // DATA: Contains all quiz cases, questions, and answers.
    // ========================================================================
    const cases = [
      {
        id: 1,
        caseNumber: 'Ca 1',
        title: 'Cơn hưng cảm có loạn thần (Bipolar I)',
        patient: 'Nam, 27 tuổi',
        description: [
          'Được đưa vào khoa cấp cứu vì 3 ngày liền không ngủ mà “vẫn rất khoẻ”, nói liên tục về kế hoạch khởi nghiệp tầm cỡ, tự nhận mình “thiên tài marketing”.',
          'Gia đình ghi nhận 1 tuần gần đây anh tăng hoạt động bất thường, tiêu tiền ồ ạt, lái xe quá tốc độ.',
          'Tại phòng khám, bệnh nhân nói nhanh, khó ngắt lời, tư duy phi tán; phủ nhận dùng chất; đêm qua anh leo vào công trường xây dựng để “check mặt bằng cho tập đoàn”.',
          'Đánh giá nguy cơ: hành vi xung động, ý nghĩ hoang tưởng tự cao thoáng qua, suy giảm chức năng nghiêm trọng; bác sĩ đề nghị nhập viện điều trị cấp.'
        ],
        questions: [
          { question: "C1. Tiêu chuẩn thời gian để chẩn đoán pha hưng cảm theo DSM-5-TR là:", options: ["≥ 4 ngày", "≥ 1 tuần hoặc bất kỳ thời gian nào nếu cần nhập viện", "≥ 2 tuần", "≥ 1 tháng"], correct: "B", explanation: "Hưng cảm: ≥1 tuần hoặc bất kỳ thời lượng nếu cần nhập viện. ≥4 ngày là hưng cảm nhẹ." },
          { question: "C2. Dấu hiệu nào không phải là triệu chứng điển hình của hưng cảm?", options: ["Nói nhiều/áp lực nói", "Giảm nhu cầu ngủ", "Tư duy phi tán", "Hoảng loạn kịch phát lặp lại"], correct: "D", explanation: "Cơn hoảng loạn không nằm trong cụm triệu chứng cốt lõi của hưng cảm." },
          { question: "C3. Trường hợp này phù hợp nhất với:", options: ["RLLC I có loạn thần", "RLLC II", "Rối loạn nhân cách", "Mất ngủ tiên phát"], correct: "A", explanation: "Có suy giảm chức năng nghiêm trọng/loạn thần → phù hợp RLLC I (Bipolar I) hơn RLLC II." },
          { question: "C4. Yếu tố nào ủng hộ quyết định nhập viện?", options: ["Mất ngủ nhẹ", "Không suy giảm chức năng", "Hành vi nguy cơ cao/xung động", "Tự xử trí được tại nhà"], correct: "C", explanation: "Hành vi nguy cơ và suy giảm nặng là chỉ định nhập viện để đảm bảo an toàn." },
          { question: "C5. Xét nghiệm sàng lọc nào hữu ích ban đầu để rà tiền sử khí sắc?", options: ["MDQ", "PCL-5", "Y-BOCS", "AUDIT"], correct: "A", explanation: "MDQ giúp sàng lọc tiền sử khí sắc gợi ý lưỡng cực." },
          { question: "C6. Trong cơn hưng cảm có hoang tưởng tự cao, dùng duy nhất thuốc chống trầm cảm sẽ dẫn tới nguy cơ gì?", options: ["Ổn định khí sắc nhanh", "Làm nặng cơn hưng cảm", "Không ảnh hưởng", "Chỉ gây an thần"], correct: "B", explanation: "Đơn trị thuốc chống trầm cảm có thể kích hoạt/chàm nặng hưng cảm (switch/hưng hoá)." },
          { question: "C7. Biện pháp nào có bằng chứng giảm nguy cơ tự sát lâu dài ở RLLC?", options: ["Benzodiazepine", "Lithium", "Thuốc ngủ Z-drug", "Stimulant"], correct: "B", explanation: "Nhiều bằng chứng cho thấy Lithium giảm tái phát và nguy cơ tự sát ở rối loạn lưỡng cực." },
          { question: "C8. Khi phân biệt với rối loạn loạn thần nguyên phát, tiêu chí cốt lõi nghiêng về hưng cảm là:", options: ["Ảo thanh kéo dài từ tuổi thiếu niên", "Khí sắc tăng/cáu bẳn + tăng năng lượng kèm cụm triệu chứng hưng cảm", "Amotivational", "Tụt cảm kéo dài 2 năm"], correct: "B", explanation: "Cụm triệu chứng khí sắc tăng + tăng năng lượng là lõi của hưng cảm." },
          { question: "C9. Triệu chứng nào trong ca là hành vi nguy cơ thường gặp ở hưng cảm?", options: ["Rửa tay lặp đi lặp lại", "Leo vào công trường ban đêm", "Né giao tiếp xã hội", "Ám ảnh sạch bẩn"], correct: "B", explanation: "Hành vi mạo hiểm/xung động là đặc trưng ở hưng cảm." },
          { question: "C10. Trong bước lượng giá ban đầu, ngoài MDQ nên bổ sung thang nào để khảo sát trầm cảm đi kèm?", options: ["PHQ-9", "HCL-32", "PSS-10", "YMRS"], correct: "A", explanation: "PHQ-9 sàng lọc/mức độ trầm cảm hiện tại." }
        ]
      },
      {
        id: 2,
        caseNumber: 'Ca 2',
        title: 'Trình diện bằng trầm cảm nhưng có tiền sử hưng cảm nhẹ (Bipolar II)',
        patient: 'Nữ, 33 tuổi',
        description: [
          '3 tuần buồn chán, mất hứng thú, ngủ kém, mệt mỏi, khó tập trung.',
          '6 tháng trước có 4–5 ngày “rất khoẻ dù ngủ 3–4 giờ”, nói nhiều, hoạt động hăng hái, giao tiếp dạn dĩ; người thân nhận ra khác thường, không suy giảm rõ.',
          '1 năm trước từng dùng SSRI sau chẩn đoán MDD, vài ngày sau bực bội/kích thích rồi tự hết.',
          'Không rượu/chất; làm văn phòng; hiện hiệu suất giảm vì uể oải.'
        ],
        questions: [
          { question: "C1. Giai đoạn hưng cảm nhẹ không có đặc điểm nào sau đây?", options: ["Loạn thần", "Không cần nhập viện", "Không suy giảm chức năng rõ", "Người xung quanh nhận thấy thay đổi"], correct: "A", explanation: "Hưng cảm nhẹ (hypomania) không có đặc điểm loạn thần." },
          { question: "C2. Chẩn đoán phù hợp nhất:", options: ["RLLC I", "RLLC II", "Cyclothymia", "MDD"], correct: "B", explanation: "Tiền sử giai đoạn hưng cảm nhẹ + hiện tại trầm cảm → phù hợp RLLC II." },
          { question: "C3. Lý do thường khiến ca như thế này bị chẩn đoán nhầm là MDD:", options: ["Trình diện chủ yếu trong pha trầm cảm ở tuyến đầu", "Vì MDQ dương tính", "Vì không có triệu chứng trầm cảm", "Vì luôn có loạn thần"], correct: "A", explanation: "RLLC II thường đến khám lúc pha trầm cảm nên dễ nhầm MDD nếu không khai tiền sử." },
          { question: "C4. Thang sàng lọc hữu ích để rà hưng cảm nhẹ:", options: ["HCL-32", "GAD-7", "CAPS-5", "PCL-5"], correct: "A", explanation: "HCL-32 (hoặc MDQ) giúp rà soát hưng cảm nhẹ trong tiền sử." },
          { question: "C5. Phát biểu đúng về dịch tễ RLLC:", options: ["RLLC phổ biến hơn MDD", "Tỉ lệ mắc suốt đời RLLC I ~1% ở phương Tây", "Nữ luôn nhiều hưng cảm hơn nam", "Không liên quan tự sát"], correct: "B", explanation: "Tỉ lệ suốt đời Bipolar I vào khoảng ~1%; RLLC liên quan đáng kể tới nguy cơ tự sát." },
          { question: "C6. Trong trầm cảm ở RLLC II, dùng đơn trị SSRI có thể gây:", options: ["Dập tắt nhanh cơn", "Chuyển cực/hưng hoá", "Không ảnh hưởng", "Luôn gây loạn thần"], correct: "B", explanation: "Đơn trị SSRI có thể gây chuyển cực hoặc làm nặng triệu chứng." },
          { question: "C7. Tiêu chí thời gian của hưng cảm nhẹ:", options: ["≥ 2 tuần", "≥ 1 tuần", "≥ 4 ngày", "≥ 1 tháng"], correct: "C", explanation: "DSM-5-TR: hưng cảm nhẹ kéo dài ≥4 ngày." },
          { question: "C8. Đặc điểm giúp phân biệt hưng cảm nhẹ với tính khí sôi nổi bình thường:", options: ["Không ai nhận thấy", "Người khác nhận ra thay đổi rõ", "Tăng năng lượng kéo dài nhưng ngủ tốt", "Luôn cần nhập viện"], correct: "B", explanation: "Hypomania có thay đổi quan sát được bởi người khác, nhưng không gây suy giảm rõ." },
          { question: "C9. Thang nào dùng nhanh để lượng giá mức trầm cảm hiện tại?", options: ["PHQ-9", "YMRS", "Y-BOCS", "MDQ"], correct: "A", explanation: "PHQ-9 lượng giá mức trầm cảm; YMRS dùng cho hưng cảm." },
          { question: "C10. Phù hợp nhất cho bước kế tiếp:", options: ["Chuẩn hóa sàng lọc (HCL-32, MDQ) + khai thác tiền sử gia đình", "Kê stimulant ngay", "Bỏ qua nguy cơ tự sát", "Chỉ tư vấn vệ sinh giấc ngủ"], correct: "A", explanation: "Cần xác nhận chẩn đoán theo phổ lưỡng cực và lập kế hoạch điều trị phù hợp." }
        ]
      },
      {
        id: 3,
        caseNumber: 'Ca 3',
        title: 'Trạng thái cảm xúc hỗn hợp (mixed features)',
        patient: 'Nam, 24 tuổi',
        description: [
          '2 tuần buồn chán/vô vọng nhưng “đầy năng lượng”, ngủ 2–3 giờ không mệt.',
          'Gia đình: kích động, đi lại liên tục, nói nhanh; ăn uống thất thường.',
          'Bệnh nhân: “đầu óc như 100 ý nghĩ bắn phá” đồng thời “cuộc đời vô nghĩa”.',
          'Không dùng chất; học tập – công việc rối loạn nặng.'
        ],
        questions: [
          { question: "C1. Mô tả trên gợi ý mạnh nhất:", options: ["Trầm cảm điển hình", "RLLC I cơn hưng cảm thuần", "Trạng thái hỗn hợp", "RLLC II"], correct: "C", explanation: "Vừa có triệu chứng tăng năng lượng/hưng tính, vừa vô vọng → hỗn hợp." },
          { question: "C2. Tính năng lượng tăng kèm ý tưởng vô vọng là đặc điểm của:", options: ["Hưng cảm có loạn thần", "Hỗn hợp", "Trầm cảm điển hình", "Lo âu lan tỏa"], correct: "B", explanation: "Sự đồng tồn tại của tăng kích hoạt/hưng và ý tưởng trầm là tiêu biểu ở hỗn hợp." },
          { question: "C3. Tuyên bố nào đúng về nguy cơ:", options: ["Trạng thái hỗn hợp tăng nguy cơ tự sát", "Không liên quan tự sát", "Luôn ít nguy cơ hơn trầm cảm", "Chỉ nguy cơ khi có ảo giác"], correct: "A", explanation: "Mixed features liên quan nguy cơ tự sát cao hơn; cần đánh giá an toàn khẩn." },
          { question: "C4. Biện pháp can thiệp ưu tiên trước mắt:", options: ["Theo dõi tại nhà", "Chỉ CBT", "Đánh giá nguy cơ tự sát khẩn + kế hoạch an toàn", "Chỉ bổ sung vitamin"], correct: "C", explanation: "Ưu tiên đảm bảo an toàn, lập kế hoạch an toàn." },
          { question: "C5. Triệu chứng nào không điển hình trong hỗn hợp?", options: ["Kích động", "Rối loạn ngủ", "Giảm chú ý do tiếng ồn", "Thay đổi ăn uống"], correct: "C", explanation: "“Giảm chú ý do tiếng ồn” không phải đặc trưng chẩn đoán." },
          { question: "C6. Chỉ định dùng đơn trị thuốc chống trầm cảm trong hỗn hợp:", options: ["Khuyến nghị", "Không khuyến nghị vì nguy cơ hưng hoá", "Bắt buộc", "Chỉ khi có loạn thần"], correct: "B", explanation: "Nguy cơ hưng hoá/switch khi dùng đơn trị thuốc chống trầm cảm." },
          { question: "C7. Thang nào giúp rà soát nhanh tiền sử khí sắc trong bối cảnh này?", options: ["MDQ", "HAM-A", "CAPS-5", "Y-BOCS"], correct: "A", explanation: "MDQ rà tiền sử lưỡng cực nhanh gọn." },
          { question: "C8. Dấu hiệu nào làm tăng cấp cứu tâm thần:", options: ["Mất ngủ đơn thuần", "Ý nghĩ chết kèm kích động – năng lượng cao", "Đói bụng", "Đau lưng cơ học"], correct: "B", explanation: "Ý nghĩ chết + kích động/năng lượng cao → nguy cơ cao cần can thiệp khẩn." },
          { question: "C9. Đặc điểm nào nghiêng về RLLC hơn rối loạn lo âu:", options: ["Lo âu lan tỏa", "Chu kỳ khí sắc, tăng năng lượng, giảm nhu cầu ngủ", "Tránh xã hội", "Lo sợ chuyên biệt"], correct: "B", explanation: "Tính chu kỳ khí sắc và giảm nhu cầu ngủ gợi ý lưỡng cực." },
          { question: "C10. Giáo dục cho gia đình nên nhấn mạnh:", options: ["Bỏ qua cảnh báo", "Nhận biết sớm dấu hiệu, quản lý stress, liên lạc hỗ trợ", "Chỉ trách mắng bệnh nhân", "Tự ý dừng thuốc"], correct: "B", explanation: "Gia đình đóng vai trò nhận diện sớm và hỗ trợ tiếp cận điều trị." }
        ]
      },
      {
        id: 4,
        caseNumber: 'Ca 4',
        title: '“Trầm cảm điều trị hoài không khỏi”: nguy cơ chẩn đoán trễ RLLC',
        patient: 'Nam, 30 tuổi',
        description: [
          '5 năm qua nhiều đợt trầm cảm tái diễn; đã dùng ≥3 SSRI/SNRI khác nhau, đáp ứng kém.',
          'Khai thác kỹ: thỉnh thoảng 3–4 ngày “sáng tạo, hoạt động dồn dập, ngủ 3–4 giờ”, người thân nhận ra khác thường, không suy giảm rõ.',
          'Vợ kể vài lần đổi việc đột ngột, chi tiêu bốc đồng trong các đợt “lên mood”.',
          'Chưa từng được sàng lọc bằng MDQ/HCL-32; hiện vào khám vì giảm năng lượng, ý nghĩ bi quan.'
        ],
        questions: [
          { question: "C1. Tuyên bố đúng về chẩn đoán RLLC trong thực hành:", options: ["Thường được phát hiện sớm", "Hay đến trễ, dễ nhầm MDD", "Không cần khai tiền sử", "Chỉ dựa hiện tại"], correct: "B", explanation: "RLLC thường trình diện ở pha trầm cảm → dễ bị chẩn đoán nhầm MDD." },
          { question: "C2. Công cụ nào nên dùng ngay để rà soát tiền sử lưỡng cực ở ca này?", options: ["MDQ/HCL-32", "GAD-7", "MoCA", "DASS-21"], correct: "A", explanation: "MDQ/HCL-32 là các thang sàng lọc tiền sử lưỡng cực." },
          { question: "C3. Chi tiết nào gợi hưng cảm nhẹ trong tiền sử?", options: ["Mất ngủ do stress 1 đêm", "3–4 ngày ngủ ít mà vẫn khoẻ, tăng hoạt động", "Sợ nhện", "Hoảng loạn tái diễn"], correct: "B", explanation: "≥4 ngày năng lượng tăng, ngủ ít nhưng vẫn khoẻ → gợi hypomania." },
          { question: "C4. Nguy cơ chính khi điều trị nhầm MDD ở bệnh nhân RLLC:", options: ["Không hiệu quả và có thể hưng hoá", "Luôn an toàn", "Chỉ gây buồn ngủ", "Không liên quan diễn tiến"], correct: "A", explanation: "Đơn trị chống trầm cảm có thể làm nặng/hưng hoá ở RLLC." },
          { question: "C5. Tiêu chuẩn nào không bắt buộc ở hưng cảm nhẹ?", options: ["Nhập viện", "Người khác nhận thấy thay đổi", "Tăng hoạt động", "Ngủ ít"], correct: "A", explanation: "Hypomania không yêu cầu nhập viện và không gây suy giảm rõ." },
          { question: "C6. Khi sàng lọc trầm cảm hiện tại, thang phù hợp:", options: ["PHQ-9", "PCL-5", "Y-BOCS", "CAGE"], correct: "A", explanation: "PHQ-9 phù hợp để lượng giá mức độ trầm cảm hiện tại." },
          { question: "C7. Chiến lược đúng trong quản lý lâu dài RLLC:", options: ["Chỉ dùng thuốc khi có cơn", "Duy trì điều trị + giáo dục BN và gia đình", "Dừng thuốc sớm khi đỡ", "Không cần theo dõi"], correct: "B", explanation: "Điều trị duy trì + psychoeducation giúp giảm tái phát." },
          { question: "C8. Phát biểu đúng về “đặc điểm thay đổi liên tục” của RLLC:", options: ["Chẩn đoán cố định suốt đời không đổi", "Biểu hiện khác nhau theo thời điểm; phân loại có thể thay đổi", "Luôn là hưng cảm", "Luôn là trầm cảm"], correct: "B", explanation: "Biểu hiện lưỡng cực biến thiên theo thời gian; chẩn đoán có thể thay đổi theo diễn tiến." },
          { question: "C9. Trong khai thác yếu tố nguy cơ, điều nào cần đặc biệt lưu ý?", options: ["Tình trạng răng miệng", "Tiền sử gia đình tự sát, lạm dụng chất, mất ngủ kéo dài", "Đau cơ mạn", "Cận thị"], correct: "B", explanation: "Các yếu tố này liên quan chặt chẽ đến nguy cơ xấu ở RLLC." },
          { question: "C10. Quyết định hợp lý nhất ở thời điểm hiện tại:", options: ["Tiếp tục xoay SSRI", "Đánh giá lại theo phổ lưỡng cực + lập kế hoạch điều trị khí sắc", "Bổ sung vitamin", "Chỉ liệu pháp thư giãn"], correct: "B", explanation: "Cần xác lập chẩn đoán đúng và lên kế hoạch điều trị khí sắc toàn diện." }
        ]
      },
      {
        id: 5,
        caseNumber: 'Ca 5',
        title: 'Lưỡng cực kèm lạm dụng rượu, nguy cơ tự sát',
        patient: 'Nam, 29 tuổi',
        description: [
          'Nhập viện sau khi uống rượu say và viết thư tuyệt mệnh; 1 năm qua có các đợt “lên mood” vài ngày (ngủ ít, nói nhanh, tiêu tiền vô độ) xen kẽ các đợt trầm kéo dài.',
          'Bạn bè cho biết gần đây uống rượu nhiều; từng cố tự sát 6 tháng trước.',
          'Gia đình không bệnh nội khoa đáng kể; cha có tiền sử trầm cảm.',
          'Hiện khám: khí sắc trầm, ý nghĩ chết, vẫn kích động nhẹ/khó dừng tay lướt điện thoại.'
        ],
        questions: [
          { question: "C1. Phát biểu đúng về tử vong trong RLLC:", options: ["Tự sát hiếm gặp", "RLLC có tỉ lệ tự sát rất cao", "Chỉ gặp ở nữ", "Chỉ khi có loạn thần"], correct: "B", explanation: "RLLC có nguy cơ tự sát cao, cần đánh giá và can thiệp kịp thời." },
          { question: "C2. Biện pháp làm giảm nguy cơ tự sát về dài hạn:", options: ["Lithium", "Chỉ tư vấn", "Z-drug", "Tăng liều rượu"], correct: "A", explanation: "Lithium có bằng chứng giảm nguy cơ tự sát lâu dài." },
          { question: "C3. Đồng mắc nào thường gặp ở RLLC và làm nặng tiên lượng?", options: ["Rối loạn ăn uống", "Nghiện rượu/chất", "Parkinson", "Tăng huyết áp"], correct: "B", explanation: "Lạm dụng rượu/chất rất thường gặp và làm tăng nguy cơ tái phát/tự sát." },
          { question: "C4. Tuyên bố đúng về đánh giá nguy cơ hiện tại:", options: ["Không cần vì bệnh nhân còn trẻ", "Phải đánh giá khẩn, lập kế hoạch an toàn", "Chỉ hẹn tái khám 1 tháng", "Tự theo dõi ở nhà"], correct: "B", explanation: "Ý tưởng chết hiện tại → cần lượng giá khẩn cấp và kế hoạch an toàn." },
          { question: "C5. Nhận định đúng về mô hình chu kỳ trong ca:", options: ["Chỉ trầm kéo dài", "Xen kẽ pha tăng khí sắc ngắn và pha trầm dài", "Chỉ hưng cảm kéo dài", "Không có chu kỳ"], correct: "B", explanation: "Mô tả rõ các pha “lên mood” ngắn xen kẽ các pha trầm kéo dài." },
          { question: "C6. Câu nào đúng về chẩn đoán phân biệt nguyên nhân do chất:", options: ["Không cần hỏi", "Phải loại trừ tác động sinh lý của chất/thuốc khi chẩn đoán các pha khí sắc", "Luôn là RLLC", "Chỉ xét nghiệm máu"], correct: "B", explanation: "Luôn phải loại trừ tác động của chất/thuốc trước khi xác quyết chẩn đoán." },
          { question: "C7. Với bệnh cảnh hiện tại, bước nào không phù hợp ngay:", options: ["Cai rượu có giám sát", "Giáo dục gia đình", "Kích hoạt đơn trị SSRI", "Theo dõi sát hành vi"], correct: "C", explanation: "Đơn trị SSRI trong bối cảnh lưỡng cực/nguy cơ tự sát cao là không phù hợp." },
          { question: "C8. Công cụ nào không phải sàng lọc lưỡng cực:", options: ["MDQ", "HCL-32", "MoCA", "PHQ-9"], correct: "C", explanation: "MoCA là sàng lọc nhận thức, không phải sàng lọc lưỡng cực." },
          { question: "C9. Yếu tố nào tăng nguy cơ tự sát ở RLLC:", options: ["Mất ngủ kéo dài", "Tính xung động", "Lạm dụng rượu", "Tất cả đúng"], correct: "D", explanation: "Mất ngủ, xung động và lạm dụng rượu đều làm tăng nguy cơ tự sát." },
          { question: "C10. Mục tiêu tư vấn quan trọng cho bạn bè/người thân:", options: ["Tránh nhắc đến điều trị", "Nhận biết dấu hiệu cảnh báo, hỗ trợ tiếp cận điều trị", "Đổ lỗi cá nhân", "Giữ bí mật mọi dấu hiệu"], correct: "B", explanation: "Mạng lưới hỗ trợ nhận biết sớm và kết nối điều trị là rất quan trọng." }
        ]
      }
    ];

    // ========================================================================
    // STATE MANAGEMENT & RENDERING LOGIC
    // ========================================================================
    document.addEventListener('DOMContentLoaded', () => {
      // --- STATE ---
      let state = {
        answers: {},
        showResults: false,
        currentCaseIndex: 0
      };

      // --- CONSTANTS ---
      const totalQuestions = cases.reduce((total, caseItem) => total + caseItem.questions.length, 0);
      const appContainer = document.getElementById('app');

      // --- ACTION HANDLERS ---
      function handleAnswerChange(caseId, questionIndex, answer) {
        if (state.showResults) return;
        state.answers[`${caseId}-${questionIndex}`] = answer;
        render();
      }

      function handleSubmit() {
        state.showResults = true;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        render();
      }

      function handleReset() {
        state = { answers: {}, showResults: false, currentCaseIndex: 0 };
        window.scrollTo({ top: 0, behavior: 'smooth' });
        render();
      }

      function setCurrentCase(index) {
        state.currentCaseIndex = index;
        render();
      }

      function navigateCase(direction) {
        if (direction === 'prev') {
          state.currentCaseIndex = Math.max(0, state.currentCaseIndex - 1);
        } else if (direction === 'next') {
          state.currentCaseIndex = Math.min(cases.length - 1, state.currentCaseIndex + 1);
        }
        render();
      }
      
      function calculateScore() {
        let correct = 0;
        cases.forEach(caseItem => {
          caseItem.questions.forEach((question, index) => {
            const answerKey = `${caseItem.id}-${index}`;
            const selectedAnswer = state.answers[answerKey];
            // The options are full strings, not letters. Find the correct string.
            const correctAnswerString = question.options[ ['A', 'B', 'C', 'D'].indexOf(question.correct) ];
            if (selectedAnswer === correctAnswerString) {
              correct++;
            }
          });
        });
        return correct;
      }

      // --- RENDER FUNCTION ---
      function render() {
        const currentCase = cases[state.currentCaseIndex];
        const score = calculateScore();
        
        let html = `
          <div class="max-w-4xl mx-auto px-4 py-8 pb-32">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
              <h1 class="text-3xl font-bold text-center text-indigo-800 mb-4">
                QUIZ TƯƠNG TÁC - PHỔ LƯỠNG CỰC
              </h1>
              <div class="text-center text-gray-600">
                <p class="text-lg font-semibold">Môn: TÂM BỆNH HỌC</p>
                <p>Bộ đề kiểm tra 5 ca lâm sàng | Tổng số câu: ${totalQuestions}</p>
              </div>
            </div>
        `;

        if (state.showResults) {
          const percentage = totalQuestions > 0 ? score / totalQuestions : 0;
          const resultText = percentage >= 0.8 ? 'Xuất sắc!' : percentage >= 0.6 ? 'Khá tốt' : 'Cần ôn lại';
          const resultColor = percentage >= 0.8 ? 'bg-green-500' : percentage >= 0.6 ? 'bg-yellow-500' : 'bg-red-500';

          html += `
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
              <h2 class="text-2xl font-bold text-center mb-4">
                <span class="text-slate-700">KẾT QUẢ BÀI LÀM</span>
              </h2>
              <div class="text-center">
                <div class="text-4xl font-bold mb-2">
                  <span class="text-green-600">${score}</span>
                  <span class="text-gray-400">/</span>
                  <span class="text-indigo-600">${totalQuestions}</span>
                </div>
                <div class="text-lg text-gray-600 mb-4">
                  Điểm số: ${((score / totalQuestions) * 10).toFixed(1)}/10
                </div>
                <div class="inline-block px-4 py-2 rounded-full text-white font-semibold ${resultColor}">
                  ${resultText}
                </div>
              </div>
            </div>
          `;
        }

        html += `
          <div class="bg-white rounded-lg shadow-lg p-4 mb-8">
            <div class="flex flex-wrap gap-2 justify-center">
              ${cases.map((caseItem, index) => `
                <button
                  class="case-nav-btn px-4 py-2 rounded-lg font-medium transition-colors ${
                    state.currentCaseIndex === index
                    ? 'bg-indigo-600 text-white'
                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }"
                  data-index="${index}"
                >
                  ${caseItem.caseNumber}
                </button>
              `).join('')}
            </div>
          </div>
        `;

        html += `
          <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-indigo-800 mb-2">${currentCase.caseNumber} – ${currentCase.title}</h2>
              <p class="text-lg text-gray-700 font-semibold">${currentCase.patient}</p>
            </div>
            <div class="mb-8">
              <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">BỆNH CẢNH:</h3>
              ${currentCase.description.map((paragraph, index) => `
                <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                  <p class="text-gray-700 leading-relaxed">
                    <span class="font-semibold">(${index + 1})</span> ${paragraph}
                  </p>
                </div>
              `).join('')}
            </div>
            <div>
              <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">CÂU HỎI:</h3>
              ${currentCase.questions.map((q, qIndex) => {
                const answerKey = `${currentCase.id}-${qIndex}`;
                const optionsWithLetters = ['A', 'B', 'C', 'D'];
                const correctAnswerString = q.options[optionsWithLetters.indexOf(q.correct)];

                let questionHtml = `
                  <div class="mb-6 p-6 border border-gray-200 rounded-lg bg-white">
                    <div class="mb-4">
                      <h4 class="font-semibold text-gray-800 text-base leading-relaxed">
                        ${q.question}
                      </h4>
                    </div>
                    <div class="space-y-3">
                `;
                
                q.options.forEach((optionText, oIndex) => {
                  const isSelected = state.answers[answerKey] === optionText;
                  const isCorrect = correctAnswerString === optionText;
                  
                  let buttonClass = 'w-full text-left p-3 border-2 rounded-lg transition-colors flex items-center ';
                  
                  if (state.showResults) {
                    if (isCorrect) {
                      buttonClass += 'border-green-500 bg-green-50 text-green-800 font-medium';
                    } else if (isSelected && !isCorrect) {
                      buttonClass += 'border-red-500 bg-red-50 text-red-800 font-medium';
                    } else {
                      buttonClass += 'border-gray-200 bg-gray-50 text-gray-600';
                    }
                  } else {
                    if (isSelected) {
                      buttonClass += 'border-indigo-500 bg-indigo-50 text-indigo-800 font-medium';
                    } else {
                      buttonClass += 'border-gray-200 hover:border-gray-300 hover:bg-gray-50';
                    }
                  }

                  questionHtml += `
                    <button
                      class="answer-btn ${buttonClass}"
                      data-case-id="${currentCase.id}"
                      data-question-index="${qIndex}"
                      data-answer-text="${optionText}"
                      ${state.showResults ? 'disabled' : ''}
                    >
                      <span class="font-bold mr-2">${optionsWithLetters[oIndex]}.</span>
                      <span>${optionText}</span>
                      ${state.showResults && isCorrect ? '<span class="ml-auto text-green-600 font-semibold">✓</span>' : ''}
                      ${state.showResults && isSelected && !isCorrect ? '<span class="ml-auto text-red-600 font-semibold">✗</span>' : ''}
                    </button>
                  `;
                });
                
                questionHtml += `</div>`;
                
                if (state.showResults) {
                  questionHtml += `
                    <div class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                      <p class="text-sm text-blue-800">
                        <span class="font-semibold">Giải thích:</span> ${q.explanation}
                      </p>
                    </div>
                  `;
                }
                
                questionHtml += `</div>`;
                return questionHtml;
              }).join('')}
            </div>
          </div>
        `;

        html += `
          <div class="flex justify-between mb-8">
            <button
              class="nav-btn-prev px-6 py-3 bg-gray-500 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-600 transition-colors"
              ${state.currentCaseIndex === 0 ? 'disabled' : ''}
            >
              ← Ca trước
            </button>
            <button
              class="nav-btn-next px-6 py-3 bg-gray-500 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-600 transition-colors"
              ${state.currentCaseIndex === cases.length - 1 ? 'disabled' : ''}
            >
              Ca tiếp theo →
            </button>
          </div>
        `;

        html += `
          </div>
          <div class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-sm border-t border-gray-200 shadow-lg p-4">
            <div class="max-w-4xl mx-auto flex gap-4 justify-center">
              <button
                id="submitBtn"
                class="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors shadow-lg disabled:opacity-60"
                ${state.showResults ? 'disabled' : ''}
              >
                NỘP BÀI
              </button>
              <button
                id="resetBtn"
                class="px-8 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors shadow-lg"
              >
                LÀM LẠI
              </button>
            </div>
            <div class="text-center mt-2 text-sm text-gray-600 font-medium">
              Đã trả lời: ${Object.keys(state.answers).length}/${totalQuestions} câu
            </div>
          </div>
        `;

        appContainer.innerHTML = html;
        
        // Re-attach event listeners after every render
        attachEventListeners();
      }
      
      // --- EVENT LISTENERS ---
      // Use event delegation to handle clicks efficiently
      function attachEventListeners() {
        appContainer.addEventListener('click', (e) => {
          // Answer buttons
          const answerBtn = e.target.closest('.answer-btn');
          if (answerBtn) {
            const caseId = parseInt(answerBtn.dataset.caseId);
            const qIndex = parseInt(answerBtn.dataset.questionIndex);
            const answer = answerBtn.dataset.answerText;
            handleAnswerChange(caseId, qIndex, answer);
            return;
          }
          
          // Case navigation tabs
          const caseNavBtn = e.target.closest('.case-nav-btn');
          if (caseNavBtn) {
            setCurrentCase(parseInt(caseNavBtn.dataset.index));
            return;
          }

          // Prev/Next buttons
          if (e.target.closest('.nav-btn-prev')) navigateCase('prev');
          if (e.target.closest('.nav-btn-next')) navigateCase('next');
          
          // Submit/Reset buttons in the footer
          if (e.target.closest('#submitBtn')) handleSubmit();
          if (e.target.closest('#resetBtn')) handleReset();
        });
      }

      // --- INITIAL RENDER ---
      render();
    });
  </script>

</body>
</html>
